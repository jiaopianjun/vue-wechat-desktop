<template>
  <div class="Chat clearfix" id="Chat">
    <div class="ChatBox"> 
      <div class="Serch">
         <input type="text" class="SerchInput" placeholder="搜索..."/>
         <div class="SerchBtn">+</div>
      </div>
      <div class="ChatList clearfix">
        <div class="ulwrapper">
          <ul>
             <li v-for="(list,index) in data.offlinelist" :class="[list.current === 'current' ? 'current':'']" :index="index"  :current= "list.current" @click="adclick(list,index)" :sessionid="list.session_id">
                <div class="li">
                    <div class="userHd">
                      <div class="userHdImg"><img :src="list.avatar"/></div>
                    </div>
                    <div class="userInfo">
                       <div class="userInfoA">
                          <span class="name textHidden">{{list.nickname}}</span>
                          <span class="userInfoTime textHidden">{{list.last_send_at}}</span>
                       </div>
                       <div class="userInfoB">
                          <span class="oneMessage textHidden">{{list.last_message}}</span>
                       </div>
                    </div>
                </div>
             </li>
          </ul>
        </div>
      </div>
    </div>
    <ChatView :chatData.sync="chatData" :isDefault.sync="isDefault" :sendMsg.sync="sendMsg"></ChatView>
  </div>
</template>
<script>
import ChatView from './ChatView.vue'
export default {
  name: 'Chat',
  components: {
    ChatView: ChatView
  },
  data () {
    return {
      chatData:{"nickname":"default"},
      isDefault:false,
      sendMsg:true,
      data:{
        offlinelist:[
          {
            "aid":"1",
            "session_id":"123",
            "avatar":"https://resplay.snail.com/community/circle_logo/15493d7e1c5335c63e04b44041953d53.jpeg",
            "nickname":"我是谁",
            "last_send_at":"昨天",
            "last_send_name":"周杰伦",
            "last_message":"你在干嘛啊",
            "message_count":0
          },
          {
            "aid":"2",
            "session_id":"124",
            "avatar":"https://resplay.snail.com/community/circle_logo/34eed3f350ee62de266c0e43b0169b73.png",
            "nickname":"周杰伦",
            "last_send_at":"昨天",
            "last_send_name":"周杰伦",
            "last_message":"你好啊",
            "message_count":0
          }
        ],
        offineContNum:0,
      },
      isAid:'',// 判断当前聊天对象是否打开聊天对话框
      getTimeUrl:'https://stoneapi.snail.com/v2/env/time',
      oldDate:0
    }
  },
  watch:{
    "$store.state.menu.list":function(){
      var selectData = $.extend(true, [], this.$store.state.menu.list),
          chatList = $.extend(true, [], this.data.offlinelist);  
      if(selectData[0]){
        this.fromFriendsList(selectData,chatList)
        this.isAid = selectData[0].aid
      }
    },
    "$store.state.realchat.chatinfolist":function(){
      var chatText = $.extend(true, {}, this.$store.state.realchat.chatinfolist),
          chatList = $.extend(true, [], this.data.offlinelist),
          defaultMessage = {
            "text": chatText.content,
            "avatar": "",
            "time":"",
            "is_type": "isOther"
          },
          nowtime = this.time(chatText.timestamp,'qt');
      if((parseInt(nowtime) - parseInt(this.oldDate)) > parseInt(3)){
        defaultMessage.time = this.time(chatText.timestamp,'all')
        this.oldDate = this.time(chatText.timestamp,'qt')
      }

      if(chatText){
        this.formChatList(chatText,chatList,defaultMessage);
      }
    },
  },
  methods: {
    time:function(unixtimestamp,type){  
      var unixtimestamp = new Date(unixtimestamp*1000);  
      var year = 1900 + unixtimestamp.getYear();  
      var month = "0" + (unixtimestamp.getMonth() + 1);  
      var date = "0" + unixtimestamp.getDate();  
      var hour = "0" + unixtimestamp.getHours();  
      var minute = "0" + unixtimestamp.getMinutes();  
      var second = "0" + unixtimestamp.getSeconds();  
      if(type === 'all'){
        return year + "-" + month.substring(month.length-2, month.length)  + "-" + date.substring(date.length-2, date.length)  
            + " " + hour.substring(hour.length-2, hour.length) + ":"  
            + minute.substring(minute.length-2, minute.length) + ":"  
            + second.substring(second.length-2, second.length);  
      }else if(type == 'hm'){
        return hour.substring(hour.length-2, hour.length) + ":"  + minute.substring(minute.length-2, minute.length)  
      }else{
        return minute.substring(minute.length-2, minute.length)
      }
    },
    formChatList:function(chatText,chatList,defaultMessage){   // 从实时聊天过来
      var tempData = [],
          alist = [], // 列表不存在当前会话
          blist = []; // 列表存在当前会话
      if(chatList[0]){ // 如果聊天存在 
        for(var i in chatList){
          if(parseInt(chatList[i].aid) !== parseInt(chatText.aid)){
            alist.push(chatList[i])  //  好友列表中无
          }else{
            blist.push(chatList[i]) //好友列表中有
          }
        }
        if(blist[0]){ // 如果存在 则说明 存在当前聊天列表中   
          defaultMessage.avatar = blist[0].avatar
          tempData.push(defaultMessage)
          blist[0].messages = $.extend(true, [], tempData)
          blist[0].message_count = blist[0].message_count + 1
          blist[0].last_message = chatText.content
          blist[0].last_send_at = this.time(chatText.timestamp,'hm')
          alist.unshift(blist[0]) // 将其提升到第一个
          this.saveFromChatRecord(blist[0],'chat_yes')
          this.data.offlinelist = $.extend(true, [], alist)
          this.$store.commit('menustate',{messageNum:parseInt(this.$store.state.menu.messageNum) + parseInt(1),applyNum:this.$store.state.menu.applyNum})
        }else{
          this.$fetch(this.getfriendInfo,{friend_aid:parseInt(chatText.aid)}).then((response) => {
          if(response.code === 200){
              var newData= response.result
              defaultMessage.avatar = newData.avatar
              newData.message_count = 1
              newData.last_message = chatText.content
              newData.last_send_at = this.time(chatText.timestamp,'hm')
              newData.current = ''
              newData.messages = []
              newData.messages.push(defaultMessage)
              this.data.offlinelist.push(newData)
              this.saveFromChatRecord(newData,'chat_no')
              this.$store.commit('menustate',{messageNum:parseInt(this.$store.state.menu.messageNum) + parseInt(newData.message_count),applyNum:this.$store.state.menu.applyNum})
            }
          })
        } 
      }else{ // 如果聊天列表不存在则说明该会话没有产生过，则需要新建一个  并且新建聊天存储区
        var _this = this
        this.$fetch(this.getfriendInfo,{friend_aid:parseInt(chatText.aid)}).then((response) => {
          if(response.code === 200){
            var newData = response.result
            defaultMessage.avatar = newData.avatar
            newData.message_count = 1
            newData.last_message = chatText.content
            newData.last_send_at = this.time(chatText.timestamp,'hm')
            newData.messages = []
            newData.current = ''
            newData.messages.push(defaultMessage)
            _this.data.offlinelist.push(newData)
            _this.saveFromChatRecord(newData,'chat_no')
            this.$store.commit('menustate',{messageNum:parseInt(this.$store.state.menu.messageNum) + parseInt(newData.message_count),applyNum:this.$store.state.menu.applyNum})
          }
        })
      }
    },
    saveFromChatRecord:function(data,type){
      var chatRecList = $.extend(true, [], this.$store.state.record.list), // 聊天记录保存列表
          DeTemp = {"session_id":data.session_id,messages:[]},
          tempData = [],
          tempData2;
      if(type === 'chat_no'){
          DeTemp.messages.push(data.messages[0])
          this.$store.commit('chatrecordstate',{data:DeTemp})
      }else if(type == "chat_yes"){
        if(data.messages[0]){
          for(var i in chatRecList){
            if(chatRecList[i].session_id === data.session_id){
              tempData = chatRecList[i].messages
            }
          }
          tempData2 = $.extend(true, [], data.messages)
          tempData.push(tempData2[0]) 
          if(this.isAid == data.aid){
            // 同时清除未读消息
            this.chatData = data
            DeTemp.messages = this.chatData.messages = $.extend(true, [], tempData)
          }else{
            DeTemp.messages = $.extend(true, [], tempData)
          }
          this.$store.commit('chatrecordstate',{data:DeTemp})
        }else{
          for(var i in chatRecList){
            if(chatRecList[i].session_id === data.session_id){
              tempData = chatRecList[i].messages
            }
          }
          this.chatData.messages = $.extend(true, [], tempData)
        }
      }
    },
    saveFromFriendsRecord:function(data,type){
      var chatRecList = $.extend(true, [], this.$store.state.record.list), // 聊天记录保存列表
          DeTemp = {"session_id":data.session_id,messages:[]},
          tempData = [];
       if(type === "friends_no"){
         this.$store.commit('chatrecordstate',{data:DeTemp})
       }else if(type === "friends_yes"){
        if(data.messages[0]){
          for(var i in chatRecList){
            if(chatRecList[i].session_id === data.session_id){
              tempData = chatRecList[i].messages
            }
          }
          DeTemp.messages = this.chatData.messages = $.extend(true, [], tempData)
          this.$store.commit('chatrecordstate',{data:DeTemp})
        }else{
          for(var i in chatRecList){
            if(chatRecList[i].session_id === data.session_id){
              tempData = chatRecList[i].messages
            }
          }
          this.chatData.messages = $.extend(true, [], tempData)
        }
       }
    },
    fromFriendsList:function(selectData,chatList){
      var alist = [], // 列表不存在当前会话
          blist = []; // 列表存在当前会话
      if(selectData[0]){ // 如果有从好友列表过来的才执行操作
        for(var i in chatList){
          if(parseInt(chatList[i].aid) !== parseInt(selectData[0].aid)){
            chatList[i].current = ''
            alist.push(chatList[i])  //  好友列表中无
          }else{
            chatList[i].current = ''
            blist.push(chatList[i]) //好友列表中有
          }
        }
        if(blist[0]){ // 如果存在 则说明 存在当前聊天列表中   
          blist[0].current = 'current'
          if(selectData[0].last_message){
            blist[0].last_message = selectData[0].last_message
            blist[0].last_send_at = selectData[0].last_send_at
          }
          alist.unshift(blist[0]) // 将其提升到第一个 
          this.chatData = $.extend(true, [], blist[0]) // 并且 打开 对话窗口
          this.saveFromFriendsRecord(blist[0],'friends_yes');
          this.claerMessageNum(blist[0].session_id,blist[0].message_count,blist[0].aid,0) // 同时清除未读消息
        }else{
          selectData[0].messages = []
          selectData[0].current = 'current'
          alist.unshift(selectData[0]) // 不存在则将从好友列表传过来的赋值
          this.chatData = $.extend(true, [], alist[0]) // 同时打开对话窗口
          this.saveFromFriendsRecord(selectData[0],'friends_no');
        }
        this.data.offlinelist = $.extend(true, [], alist)
        $(".Chat .ulwrapper li").removeClass('current').eq(0).addClass('current');
      }
    },
    adclick:function(list,index){
      var dom = event.currentTarget,
          chatrecordata = this.$store.state.record.list,
          messages,
          DeTemp = {"session_id":list.session_id,messages:[]};
      $(".Chat .ulwrapper li").removeClass('current');
      $(dom).addClass('current');
      this.isAid = list.aid
      if(chatrecordata.length > 0){ 
        for(var i in chatrecordata){
          if(chatrecordata[i].session_id === list.session_id){
             messages = chatrecordata[i].messages
          }
        }
        list.messages = $.extend(true, [], messages)
      }else{
        if(list.messages){
          DeTemp.messages = list.messages
          this.$store.commit('chatrecordstate',{data:DeTemp})
        }
      }
      this.chatData = list
      this.isDefault = this.sendMsg = true
    },
  },
  mounted(){

  },
  created: function () {
   
  }
}
</script>
<style scoped>
 @import '../sass/stylesheets/Chat.css'
</style>
